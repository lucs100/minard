{% extends "layout.html" %}
{% block title %}Slow Control Plots{% endblock %}
{% block head %}
    <!-- metrics-graphics stylesheet goes above super() because we want bootstrap's style
    (which is linked in super()) to override it. -->
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static',filename='css/metricsgraphics.css') }}">
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static',filename='css/mg_line_brushing.css') }}">
  {{ super() }}
  <style>
    .btn2 {
        background-color: #228B22;
        padding: 6px 6px;
        color: white;
        text-align: center;
        font-size: 14px;
        margin: 4px 2px;
        cursor: pointer;
    }
  </style>
{% endblock %}
{% block body %}
    {{ super() }}

    <div class="page-header">
        <h1 align="center">Slow Control Plots</h1>
    </div>

    <!-- Set up display options -->
    <div class="container">
        <div class="col-md-12">
            <table class="table table-hover">
            <tr>
                <th> Date Range: </th>
                <th> Datastream: </th>
                <th> </th>
            </tr>
            <tr>
                <!-- Data datetime inputs -->
                <th>
                    <div>
                        <input style="margin-bottom: 30px;" type="datetime-local" id="datetime_low" value="{{datetime_low}}" required></input> 
                    </div>
                    <div>
                        <input style="margin-bottom: 30px;" type="datetime-local" id="datetime_high" value="{{datetime_high}}" required></input>
                    </div>
                </th>
                <!-- Channel selector -->
                <th>
                    <div>
                        <label for="supply">Supply Voltage</label>
                        <input type="radio" id="supply" value="supply" name="channel-type" checked>
                        <label for="supply-rack">Rack #</label>
                        <select name="supply-rack" id="supply-rack">
                            <option disabled selected hidden>...</option>
                            <option value="1">Rack 1</option>
                            <option value="2">Rack 2</option>
                            <option value="3">Rack 3</option>
                            <option value="4">Rack 4</option>
                            <option value="5">Rack 5</option>
                            <option value="6">Rack 6</option>
                            <option value="7">Rack 7</option>
                            <option value="8">Rack 8</option>
                            <option value="9">Rack 9</option>
                            <option value="10">Rack 10</option>
                            <option value="11">Rack 11</option>
                            <option value="timing">Timing Rack</option>
                        </select>
                        <label for="supply-voltage">Voltage</label>
                        <select name="supply-voltage" id="supply-voltage">
                            <option disabled selected hidden id="default-voltage">...</option>
                            <option value="24">24V</option>
                            <option value="-24">-24V</option>
                            <option value="8" id="supply-flippy">8V</option>
                            <option value="5">5V</option>
                            <option value="-5">-5V</option>
                            <option value="mtcd" id="mtcd" hidden>MTCD 2V</option>
                        </select>
                    </div>

                    <div>
                        <label for="baseline">Baseline Voltage</label>
                        <input type="radio" id="baseline" value="baseline" name="channel-type" checked>
                        <label for="baseline-crate">Crate #</label>
                        <input type="number" id="baseline-crate" name="baseline-crate" min="0" max="18" value="" style="width: 4em">
                        <label for="baseline-trigger">Trigger</label>
                        <select name="baseline-trigger" id="baseline-trigger">
                            <option disabled selected hidden>...</option>
                            <option value="100">N100_BL</option>
                            <option value="20">N20_BL</option>
                        </select>
                    </div>
                </th>
                <!-- Button to plot the data -->
                <th class="col-xs-3 col-xs-offset-0">
                    <button type=button onclick="history();">Generate Plot</button>
</th>
</tr>
</table>
    <div class="row">
    <div class="col-md-12" id="sum">
        <div id="waiting">
            Received data, loading...
        </div>
    </div>
        </div>
<!-- Plot goes here -->
    <div class="row">
    <div class="col-md-12" id="main">
      {% if not slow_data %}
        <h2 align="left"> No data </h2>
      {% endif %}

    </div>
        </div>

    </div>
</div>

{% endblock %}

{% block script %}
    <script src="{{ url_for('static', filename='js/d3.js') }}"></script>
    <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/moment-timezone-with-data.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tzscale.js') }}"></script>
    <script src="{{ url_for('static', filename='js/metricsgraphics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mg_line_brushing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/stream_utilities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/slowcontrol_plots.js') }}"></script>
    <script>
        if (url_params.datetime_low && document.getElementById("datetime_low").value == "") {
            document.getElementById("datetime_low").value = url_params.datetime_low;
        }
        if (url_params.datetime_high && document.getElementById("datetime_high").value == "") {
            document.getElementById("datetime_high").value = url_params.datetime_high;
        }
        if (url_params.channel_type) {
            document.getElementById(url_params.channel_type).checked = true 
        }
        // if (url_params.supply_rack) {
        //     document.getElementById("supply-rack").value = url_params.supply_rack;
        // }
        // if (url_params.supply_voltage) {
        //     document.getElementById("supply-voltage").value = url_params.supply_voltage;
        // }
        // if (url_params.baseline_crate) {
        //     document.getElementById("baseline-crate").value = url_params.baseline_crate;
        // }
        // if (url_params.baseline_trigger) {
        //     document.getElementById("baseline-trigger").value = url_params.baseline_trigger;
        // }

        function initializeStoredArray(name) {
            rawValue = sessionStorage.getItem(name)
            if ((typeof rawValue !== "undefined") && (rawValue !== null))  { //probably only need "null" 
                return JSON.parse(rawValue)
            }
            else {
                return []
            }
        }

        function storeArray(name, data) {
            return sessionStorage.setItem(name, JSON.stringify(data))
        }

        var newSlowData = {{ slow_data | safe if slow_data else 'null' }};
        var newDataName = "{{ data_name | safe if data_name else 'null' }}"; // this sucks, fix it

        var slowData = initializeStoredArray("storedSlowData")
        var dataNames = initializeStoredArray("storedDataNames")

        if (newSlowData !== null) { //unfortunate, but null handling is hard
            slowData.push(newSlowData)
        }
        if (newDataName !== null) {
            dataNames.push(newDataName)
        }

        if (slowData.length > 0) {
            const headData = slowData[0] // first array of data, avoids slowData[0][i]['key'] etc

            for (var i=0; i < headData.length; i++) {
                headData[i]['key'] = moment.unix(headData[i]['key']).toDate()
            }

            minTime = headData[0]['key'];
            maxTime = headData[headData.length-1]['key'];
            var cscale = tzscale().domain([minTime, maxTime]).zone('America/Toronto');
        } 
        var time_fmt = 'MMMM Do YYYY, h:mm:ss a';
        
    // <!-- Messy bit of code to get the run summary section but it works... -MD -->
    //copied from runselection_plots, a summary is probably unneccesary here
    // 	var summaryTime = [rs_plot_data[rs_plot_data.length - 1]['phys_total'],rs_plot_data[rs_plot_data.length - 1]['pass_total'],rs_plot_data[rs_plot_data.length - 1]['fail_total'],rs_plot_data[rs_plot_data.length - 1]['purg_total']]
        
    //     var summaryRuns = [rs_plot_data[rs_plot_data.length - 1]['phys_runs'],rs_plot_data[rs_plot_data.length - 1]['pass_runs'],rs_plot_data[rs_plot_data.length - 1]['fail_runs'],rs_plot_data[rs_plot_data.length - 1]['purg_runs']]
    

    // for (var i=0; i < summaryTime.length; i++)
    //     {
    //         var j = parseFloat(summaryTime[i]).toFixed(3);
    //         summaryTime[i] = j;
    //     }

	// document.getElementById("phys_summary").innerHTML = 'Physics: ' + summaryTime[0].toString() + ' Days, ' +summaryRuns[0].toString() + ' Runs';
    // if (summaryRuns[1] == 0) {document.getElementById("pass_summary").innerHTML = 'Passed: None';}
    // else{document.getElementById("pass_summary").innerHTML = 'Passed: ' + summaryTime[1].toString() + ' Days, ' +summaryRuns[1].toString() + ' Runs';}
    // if (summaryRuns[2] == 0) {document.getElementById("fail_summary").innerHTML = 'Failed: None';}
    // else{document.getElementById("fail_summary").innerHTML = 'Failed: ' + summaryTime[2].toString() + ' Days, ' +summaryRuns[2].toString() + ' Runs';}
    // if (summaryRuns[3] == 0) {document.getElementById("purg_summary").innerHTML = 'Purgatory: None';}
    // else{document.getElementById("purg_summary").innerHTML = 'Purgatory: ' + summaryTime[3].toString()  + ' Days, ' +summaryRuns[3].toString() + ' Runs';}

        var dparams = {
            area: false,
            data: slowData,
            width: $('#main').width(),
            left: 100,
            right: 100,
            height: 500,
            target: "#main",
            time_scale: cscale,
            x_accessor:'key',
            y_accessor:'value',
            point_size: 4.0,
            x_label: "Time",
            y_label: "Voltage",
            decimals: 4,
            legend: dataNames,
            interpolate: 'linear',

            y_mouseover: function(data, index) {
                var voltage = parseFloat(data['value']).toFixed(4);
                return voltage + ' V';
            },

            x_mouseover: function(data, index) {
                return moment(data.key).format(time_fmt);
            }
        };

        if (slowData.length > 0) {
            MG.data_graphic(dparams); //replaces "No data" text
        }
        
        document.getElementById("waiting").innerHTML="";

        // the only way to change line width, i tried. ugh
        // changing dparams or overriding CSS did NOT work, for me at least
        document.querySelectorAll('#main svg path.mg-main-line').forEach(function(path) {
            path.style.strokeWidth = '4px';
        });
        document.querySelectorAll('#main svg .mg-line-legend text').forEach(function(text) {
            text.style.fontSize = '1.2em';
            text.style.fontWeight = '600';
        });
        document.querySelectorAll('.mg-x-axis text, .mg-y-axis text, .mg-histogram .axis text').forEach(function(text) {
            text.style.fontSize = '1.1em';
        });

        function history() {
            var params = {};
            try {
                params['datetime_low'] = document.getElementById("datetime_low").value;
            } catch (e) {
                params['datetime_low'] = "2024-02-19T00:00";
            }
            try {
                params['datetime_high'] = document.getElementById("datetime_high").value;
            } catch (e) {
                params['datetime_high'] = "2024-05-29T23:59";
            }
            try {
                params['channel_type'] = document.querySelector("input[name=channel-type]:checked").value;
            } catch (e) {
                //pass?
            }
            try {
                params['supply_rack'] = document.getElementById("supply-rack").value;
            } catch (e) {
                params['supply_rack'] = "1";
            }
            try {
                params['supply_voltage'] = document.getElementById("supply-voltage").value;
            } catch (e) {
                params['supply_voltage'] = "24";
            }
            try {
                params['baseline_crate'] = document.getElementById("baseline-crate").value;
            } catch (e) {
                params['baseline_crate'] = "0";
            }
            try {
                params['baseline_trigger'] = document.getElementById("baseline-trigger").value;
            } catch (e) {
                params['baseline_trigger'] = "100";
            }
            // try {
            //     params['criteria'] = document.getElementById("crit").value;
            // } catch (e) {
            //     params['criteria'] = "scintillator_silver";
            // }
            window.location.replace($SCRIPT_ROOT + "/slowcontrol_plots?" + $.param(params));
        }

    </script>
{% endblock %}
